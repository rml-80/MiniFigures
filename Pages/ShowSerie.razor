@page "/{serieToShow}"
@using MiniFigures.Models
@using MiniFigures.Data
@inject IMiniFigureService Mini
@inject ISeriesService SeriesService
@inject NavigationManager NavigationManager

<div class="row" style="text-align:center; background-color:@Color; border-radius:15px;height:4rem; padding-top:inherit ">
    <div style="width:20%">
    </div>
    <div style="width:60%">
        <h3>@serieToShow</h3>
    </div>
    <div style="width:20%;text-align:right">
        <button @onclick="() => ShowInfo()">Show information</button>
    </div>
</div>

@if (MF == null)
{
    <h4>Loading.......</h4>
}
else if (MF.Count == 0)
{
    <div style="text-align:center"><h4>No Figures in collection</h4></div>
}
else
{
    <div style="display:@HideShow">
        <div class="row" style="width:100%">
            <div class="col-md-2">Number: @series.Number</div>
            <div style="float:right; text-align:right"><button @onclick="() => ToEdit()">Edit</button></div>
        </div>
        <div>Number of figures: @series.NumberOfFigures</div>
        <div>Series color: @series.SeriesColor</div>
    </div>
    <h4>You own @owned of @MF.Count</h4>
    <div class="card-deck">
        @foreach (var figure in MF)
        {
            <div class="card-body" style="background-color:@Color; max-width: 265px; height:390px ;padding:15px; margin:5px auto 5px auto; border-radius:15px">
                <div class="card-body" style="background-color:white; text-align: center;width: 235px; height: 360px; border-radius: 10px; padding-top:10px">
                    <div style="text-align:left;font-weight:bolder;color:@Color">@figure.Number</div>
                    <img src="@figure.ImgURL" style="max-width:210px;height:200px" alt="Picture of @figure.Name" @onclick="(() => IncrementMF(figure.Number))" />
                    <h4 class="card-title">@figure.Name</h4>
                    <table style="margin-bottom:10px; line-height:1">
                        <tr>
                            <td style="text-align:right; width:60%">In display:</td>
                            <td style="width:40%"><i class=@changeIcon(figure.Displayed) style=@iconColor></i></td>
                        </tr>
                        <tr>
                            <td style="text-align:right">Ownd openend:</td>
                            <td>@figure.CountOpened</td>
                        </tr>
                        <tr>
                            <td style="text-align:right">Ownd sealed:</td>
                            <td>@figure.CountSealed</td>
                        </tr>
                    </table>
                    <div style="text-align:right;color:@Color"><a class="fas fa-info-circle fa-2x" @onclick="(() => ShowOne(figure.Number))"></a></div>
                </div>
            </div>
        }
    </div>
}
@code {
    [Parameter]
    public string serieToShow { get; set; }
    List<MiniFigure> MF;
    public int number { get; set; }
    protected MiniFigure SingleMF = new MiniFigure();
    public Series series { get; set; }
    public string Color { get; set; }
    public string Icon { get; set; }
    public string iconColor { get; set; }
    public int owned { get; set; }
    public string HideShow { get; set; } = "none";

    protected override async Task OnInitializedAsync()
    {
        series = await SeriesService.GetOneSerie(serieToShow);
    }

    protected override async Task OnParametersSetAsync()
    {
        await SendCollectionName(serieToShow);
        series = await SeriesService.GetOneSerie(serieToShow);
        Color = series.SeriesColor;
        Owned();
    }
    public async Task SendCollectionName(string collectionName)
    {
        MF = Mini.GetMiniFigures(collectionName);
    }
    private void ShowOne(int number)
    {
        var figure = number.ToString();
        NavigationManager.NavigateTo($"/{serieToShow}/{figure}");
    }
    private async Task IncrementMF(int number)
    {
        SingleMF = await Mini.GetOneMiniFigure(serieToShow, number);
        if (SingleMF.CountSealed == 0 && SingleMF.CountOpened == 0 || SingleMF.Displayed == true)
        {
            SingleMF.CountSealed++;
            owned++;
        }
        else if (SingleMF.CountSealed == 1 && SingleMF.CountOpened == 0)
        {
            SingleMF.CountSealed = 0;
            SingleMF.CountOpened++;
        }
        else if (SingleMF.CountOpened == 1)
        {
            SingleMF.Displayed = true;
        }

        await Mini.EditFigure(SingleMF.ID, SingleMF, serieToShow);
        await SendCollectionName(serieToShow);
    }
    private void Owned()
    {
        owned = 0;
        foreach (var figure in MF)
        {
            if (figure.CountSealed > 0 || figure.CountOpened > 0)
            {
                owned++;
            }
        }
    }
    private string changeIcon(bool test)
    {
        if (test)
        {
            Icon = "fas fa-check";
            iconColor = "color:green";
        }
        else
        {
            Icon = "fas fa-times";
            iconColor = "color:red";
        }
        return Icon;
    }

    void ToEdit()
    {
        NavigationManager.NavigateTo($"/{serieToShow}/edit");
    }
    void ShowInfo()
    {
        HideShow = "inline";
    }
    void HideInfo()
    {
        HideShow = "none";
    }
}

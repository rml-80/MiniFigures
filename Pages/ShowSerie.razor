@page "/{serieToShow}"
@using MiniFigures.Models
@using MiniFigures.Data
@inject IMiniFigureService MiniFigureService
@inject ISeriesService SeriesService
@inject NavigationManager NavigationManager
<link href="/css/Serie.css" rel="stylesheet" />

@if (ListOfMF == null)
{
    <h2>Loading.......</h2>
}
else if (ListOfMF.Count == 0)
{
    <Header serie="series" listOfFigures="ListOfMF" />
    <div class="headerCenter">
        <h4 class="marginBig">No Figures in collection</h4>
        <input type="button" value="Add Figure" @onclick="ToAdd" /> <input type="button" value="Edit serie" @onclick="ToEdit" />
    </div>
}
else
{
    <Header serie="series" listOfFigures="ListOfMF" />
    <h4>
        You own @owned of @series.NumberOfFigures
        @if (owned == series.NumberOfFigures)
        {
            <i class="fas fa-star" style="color:@series.SeriesColor" />
        }
    </h4>
    <div class="card-deck">
        @foreach (var figure in ListOfMF)
        {
            <div class="Card" style="border-color:@series.SeriesColor">
                <div style="height:22rem" >
                    <div class="txtLeftBold" style="color:@series.SeriesColor">@figure.Number</div>
                    <img src="/images/@serieToShow/@figure.Image" alt="Picture of @figure.Name"@onclick="(() => ShowCard(figure.Number))" />
                    <table>
                        <tr>
                            <td colspan="3">
                                <h5>@figure.Name</h5>
                            </td>
                        </tr>
                        <tr>
                            <td class="labelSmall">In display:</td>
                            <td>
                                @if (!figure.Displayed)
                                {
                                    <i class="fas fa-times" style="color:red" />
                                }
                                else
                                {
                                    <i class="fas fa-check" style="color:green" />
                                }
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="labelSmall">Ownd openend:</td>
                            <td>@figure.CountOpened</td>
                            <td class="fas fa-plus-circle infoBtn" style="        color: @series.SeriesColor; margin-top:0.2rem;" @onclick="() => add(1,figure.Number)"></td>
                        </tr>
                        <tr>
                            <td class="labelSmall">Ownd sealed:</td>
                            <td>@figure.CountSealed</td>
                            <td class="fas fa-plus-circle infoBtn" style="color:@series.SeriesColor; margin-top:0.2rem" @onclick="() => add(2,figure.Number)"></td>
                        </tr>
                    </table>
                </div>
                <a class="fas fa-plus-circle fa-2x infoBtn" style="color:@series.SeriesColor" @onclick="(() => IncrementListOfMF(figure.Number))" />
            </div>
        }
        @if (showCard)
        {
            <div class="modal fade show" style="display:block;background-color: rgba(255,255,255,.8);" aria-modal="true" role="dialog" @onclick="HideCard">
                <i class="fas fa-times fa-2x closeBtn" @onclick="HideCard" />
                <div class="modal-dialog" @onclick:stopPropagation="true">
                    <div class="modal-content" style="background-color:transparent; border:none">
                        <CardFrameFlip serieToShow="@serieToShow" number="@no" />
                    </div>
                </div>
            </div>
        }
    </div>
}
@code {
    [Parameter]
    public string serieToShow { get; set; }

    List<MiniFigure> ListOfMF;

    protected MiniFigure OneMF = new MiniFigure();

    protected Series series { get; set; }
    bool showCard = false;
    protected int owned { get; set; }
    protected int no { get; set; }

    protected override async Task OnInitializedAsync()
    {
        series = await SeriesService.GetOneSerie(serieToShow);

    }
    //protected override async Task OnParametersSetAsync()
    //{
    //    GetFigures(serieToShow);
    //    series = await SeriesService.GetOneSerie(serieToShow);
    //    Owned();
    //}
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await GetSerie();
        GetFigures(serieToShow);
        Owned();

        StateHasChanged();
    }
    private async Task GetSerie()
    {
        series = await SeriesService.GetOneSerie(serieToShow);
    }
    private void GetFigures(string collectionName)
    {
        ListOfMF = MiniFigureService.GetMiniFigures(collectionName);
    }
    private void ShowCard(int number)
    {
        no = number;
        showCard = true;
    }
    public void HideCard()
    {
        showCard = false;
        //NavigationManager.NavigateTo($"{serieToShow}",true );
    }
    private async Task IncrementListOfMF(int number)
    {
        OneMF = await MiniFigureService.GetOneMiniFigure(serieToShow, number);
        if (OneMF.CountSealed == 0 && OneMF.CountOpened == 0 || OneMF.Displayed == true)
        {
            if (OneMF.CountSealed == 1 && OneMF.CountOpened != 1)
            {
                owned++;

            }
            OneMF.CountSealed++;
        }
        else if (OneMF.CountSealed == 1 && OneMF.CountOpened == 0)
        {
            OneMF.CountSealed = 0;
            OneMF.CountOpened++;

        }
        else if (OneMF.CountOpened == 1)
        {
            OneMF.Displayed = true;
        }
        await MiniFigureService.EditFigure(OneMF.ID, OneMF, serieToShow);
        GetFigures(serieToShow);
    }
    private void Owned()
    {
        owned = 0;
        foreach (var figure in ListOfMF)
        {
            if (figure.CountSealed > 0 || figure.CountOpened > 0)
            {
                owned++;
            }
        }
        if (owned == series.NumberOfFigures)
        {
            series.isComplete = true;
        }
        else
        {
            series.isComplete = false;
        }
        SeriesService.EditSerie(series.Id, series);
    }
    private void ToEdit()
    {
        NavigationManager.NavigateTo($"/{serieToShow}/edit");
    }
    private void ToAdd()
    {
        NavigationManager.NavigateTo($"/addnew/figures/{serieToShow}");
    }
    private async Task add(int i, int number)
    {
        OneMF = await MiniFigureService.GetOneMiniFigure(serieToShow, number);
        switch (i)
        {
            case 1:
                OneMF.CountOpened++;
                showCard = false;
                break;
            case 2:
                OneMF.CountSealed++;
                showCard = false;
                break;
            default:
                break;
        }
        await MiniFigureService.EditFigure(OneMF.ID, OneMF, serieToShow);
        //GetFigures(serieToShow);
        //StateHasChanged();
    }
}
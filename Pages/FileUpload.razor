@page "/fileupload/{serie}"

@using System.IO
@using Microsoft.AspNetCore.Hosting

@inject IWebHostEnvironment env
@inject NavigationManager NavigationManager

<h5>@Message</h5>

<form>
    <InputFile OnChange="OnInputFileChange" multiple />
    <div class="btnRow">
        <input class="btn btn-outline-dark" type="button" @onclick="@cancel" value="Cancel" />
        <input class="btn btn-outline-success" type="button" @onclick="@OnSubmit" value="Next" />
    </div>
</form>
@code {
    [Parameter] public string serie { get; set; }

    string Message = "";
    IReadOnlyList<IBrowserFile> selectedFiles;

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        selectedFiles = e.GetMultipleFiles();
        this.StateHasChanged();
    }

    private void OnSubmit()
    {
        if (Directory.Exists($"{env.WebRootPath}\\images\\{serie}"))
        {
            Upload();
        }
        else
        {
            Directory.CreateDirectory($"{env.WebRootPath}\\images\\{serie}");
            Upload();
        }
    }

    private async void Upload()
    {
        foreach (var file in selectedFiles)
        {
            var path = $"{env.WebRootPath}\\images\\{serie}\\{file.Name}";
            if (File.Exists(path))
            {
                Message = $"File already exist";
            }
            else
            {
                Stream stream = file.OpenReadStream();
                FileStream fs = File.Create(path);
                await stream.CopyToAsync(fs);
                stream.Close();
                fs.Close();
                Message = $"{selectedFiles.Count} file(s) uploaded on server";
                NavigationManager.NavigateTo($"/addnew/figures/{serie}");
            }
        }
        this.StateHasChanged();
    }

    private void cancel() => NavigationManager.NavigateTo("/");

}
